<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Quiz</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
  * { box-sizing: border-box; margin:0; padding:0; font-family:'Montserrat', sans-serif; }
  html, body { height: 100%; width: 100%; }
  :root { --bg-color: linear-gradient(135deg, #00bcd4, #00796b); --text-color: #111827; --card-bg: #ffffff; --choice-bg: rgba(255,255,255,0.15); --choice-border: #e5e7eb; }
  [data-theme="dark"] { --bg-color: linear-gradient(135deg, #121212, #1e1e1e); --text-color: #f1f1f1; --card-bg: #1e1e1e; --choice-bg: rgba(255,255,255,0.05); --choice-border: #555; }
  body { background: var(--bg-color); color: var(--text-color); overflow: hidden; display: flex; justify-content: center; align-items: center; transition: background 0.3s, color 0.3s; position: relative; }

  .circle { position:absolute; border-radius:50%; opacity:0.15; animation: float 10s infinite ease-in-out alternate; pointer-events:none; }
  .circle1 { width:200px; height:200px; top:-50px; left:-50px; background:#fff; }
  .circle2 { width:300px; height:300px; bottom:-100px; right:-80px; background:#000; animation-duration:12s; }
  @keyframes float { from { transform: translateY(0); } to { transform: translateY(30px); } }

  .quiz-card { background: var(--card-bg); border-radius:20px; padding:20px; width:90%; max-width:500px; box-shadow:0 10px 25px rgba(0,0,0,0.15); position:relative; z-index:1; display: flex; flex-direction: column; justify-content: flex-start; max-height: 90vh; overflow: hidden; transition: background 0.3s; }
  h1 { text-align:center; font-size:28px; font-weight:700; color:#00796b; margin-bottom:15px; }
  .status-bar { display:flex; justify-content:space-between; font-weight:600; margin-bottom:15px; }
  .status-bar span { font-weight:bold; }
  .progress-container { width:100%; background:#e5e7eb; height:10px; border-radius:10px; overflow:hidden; margin-bottom:15px; }
  .progress-bar { height:100%; width:0%; background: linear-gradient(45deg, #00bcd4, #00796b); border-radius:10px; transition: width 1s linear; }
  #noQuizMsg { display:none; text-align:center; color:#d32f2f; font-weight:700; font-size:16px; margin-bottom:15px; }

  .question { display:none; margin-bottom:15px; }
  .question.active { display:block; }
  .question h2 { font-size:18px; font-weight:700; margin-bottom:10px; color:#00796b; }
  .choices label { display:flex; align-items:center; gap:10px; padding:8px 10px; border-radius:10px; border:1px solid var(--choice-border); background:var(--choice-bg); cursor:pointer; transition: all 0.3s; font-size:14px; color:var(--text-color); }
  .choices label:hover { background: rgba(0,188,212,0.15); border-color:#00bcd4; }
  .choices input[type="radio"] { accent-color:#00796b; }
  .correct { background:#ecfdf5 !important; border-color:#065f46 !important; color:#065f46 !important; transition: all 0.3s; }
  .incorrect { background:#fef2f2 !important; border-color:#991b1b !important; color:#991b1b !important; transition: all 0.3s; }

  #submitBtnContainer { text-align: center; margin-top: 10px; }
  #submitBtn { background: linear-gradient(45deg, #00bcd4, #00796b); color:#fff; font-weight:700; padding:8px 18px; border:none; border-radius:25px; cursor:pointer; transition:0.3s; display:none; }
  #submitBtn:hover { opacity:0.9; transform: translateY(-2px); }

  @media (max-width:700px){ body { padding:0; overflow:hidden; } .circle1, .circle2 { display:none; } .quiz-card { max-width:95%; max-height:95%; padding:15px; overflow-y:auto; border-radius:15px; } h1 { font-size:22px; } .question h2 { font-size:16px; } .choices label { font-size:13px; padding:6px 8px; } .progress-container { height:8px; } #submitBtn { padding:6px 15px; font-size:13px; } }
</style>
</head>
<body>
  <div class="circle circle1"></div>
  <div class="circle circle2"></div>

  <div class="quiz-card">
    <h1>Quiz Time!</h1>

    <div id="noQuizMsg">No quiz available for this semester!</div>
    <div class="status-bar">
      <div>Time Left: <span id="timer">15</span> sec</div>
      <div>Score: <span id="scoreDisplay">0</span></div>
    </div>
    <div class="progress-container">
      <div id="progressBar" class="progress-bar"></div>
    </div>

    <form id="quizForm" method="POST" action="{{ url_for('submit_quiz') }}">
      {% for q in questions %}
      <div class="question" data-id="{{ q.id }}" data-correct-index="{{ q.correct_index }}">
        <h2>{{ loop.index }}. {{ q.question }}</h2>
        <div class="choices">
          <label><input type="radio" name="q{{ q.id }}" value="0" required> {{ q.choice1 }}</label>
          <label><input type="radio" name="q{{ q.id }}" value="1"> {{ q.choice2 }}</label>
          <label><input type="radio" name="q{{ q.id }}" value="2"> {{ q.choice3 }}</label>
          <label><input type="radio" name="q{{ q.id }}" value="3"> {{ q.choice4 }}</label>
        </div>
      </div>
      {% endfor %}
      <!-- Hidden inputs for submission -->
      <input type="hidden" name="score" id="score">
      <input type="hidden" name="username" value="{{ username }}">
      <input type="hidden" name="faculty" value="{{ faculty }}">
      <input type="hidden" name="course" value="{{ course }}">
      <input type="hidden" name="semester" value="{{ semester }}">
      <input type="hidden" name="submitted_at" id="submittedAt">
    </form>

    <div id="submitBtnContainer">
      <button type="button" id="submitBtn">Submit Quiz</button>
    </div>
  </div>

<script>
  // Theme
  document.documentElement.setAttribute('data-theme', localStorage.getItem('theme') || 'light');

  // Shuffle helper
  function shuffleArray(array) { for(let i=array.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [array[i],array[j]]=[array[j],array[i]]; } return array; }

  let questions=Array.from(document.querySelectorAll('.question'));
  questions=shuffleArray(questions);
  const quizForm=document.getElementById('quizForm');
  questions.forEach(q=>quizForm.appendChild(q));

  questions.forEach((q,idx)=>{
    const h2=q.querySelector('h2');
    const text=h2.textContent.split('. ');
    if(text.length>1) h2.textContent=(idx+1)+'. '+text.slice(1).join('. ');
    const choicesDiv=q.querySelector('.choices');
    const labels=Array.from(choicesDiv.querySelectorAll('label'));
    const correctIndex=parseInt(q.getAttribute('data-correct-index'));
    let choiceArray=labels.map((label,index)=>({label,index}));
    shuffleArray(choiceArray);
    choicesDiv.innerHTML='';
    choiceArray.forEach((c,newIndex)=>{
      choicesDiv.appendChild(c.label);
      c.label.querySelector('input').value=newIndex;
      if(c.index===correctIndex) q.setAttribute('data-correct-index',newIndex);
    });
  });

  const timerSpan=document.getElementById('timer');
  const submitBtn=document.getElementById('submitBtn');
  const scoreInput=document.getElementById('score');
  const scoreDisplay=document.getElementById('scoreDisplay');
  const progressBar=document.getElementById('progressBar');
  const submittedAtInput=document.getElementById('submittedAt');

  let currentQuestion=0,timeLeft=15,score=0,timer;

  function showQuestion(index){
    const noQuizMsg=document.getElementById('noQuizMsg');
    if(questions.length===0){ noQuizMsg.style.display='block'; quizForm.style.display='none'; progressBar.style.width='0%'; submitBtn.style.display='none'; timerSpan.textContent='0'; scoreDisplay.textContent='0'; return; }
    noQuizMsg.style.display='none'; quizForm.style.display='block';
    questions.forEach((q,i)=>q.classList.toggle('active',i===index));
    progressBar.style.width=(currentQuestion/questions.length*100)+'%';
    resetTimer();
  }

  function resetTimer(){ clearInterval(timer); timeLeft=15; timerSpan.textContent=timeLeft; timer=setInterval(()=>{ timeLeft--; timerSpan.textContent=timeLeft; if(timeLeft<=0) checkAnswerAndNext(); },1000); }

  function checkAnswerAndNext(){
    clearInterval(timer);
    const current=questions[currentQuestion];
    const selected=current.querySelector('input[type="radio"]:checked');
    const correctAnswerIndex=parseInt(current.getAttribute('data-correct-index'));
    const choices=current.querySelectorAll("label");
    if(selected){
      const selectedIndex=parseInt(selected.value);
      current.querySelectorAll('input[type="radio"]').forEach(r=>r.disabled=true);
      choices.forEach((label,idx)=>{
        label.classList.remove("correct","incorrect");
        if(idx===correctAnswerIndex) label.classList.add("correct");
        if(idx===selectedIndex && selectedIndex!==correctAnswerIndex) label.classList.add("incorrect");
      });
      if(selectedIndex===correctAnswerIndex){ score++; scoreDisplay.textContent=score; }
    }
    setTimeout(()=>{
      currentQuestion++;
      if(currentQuestion<questions.length) showQuestion(currentQuestion);
      else {
        scoreInput.value=score;
        progressBar.style.width='100%';
        // record submitted_at in Nepali datetime
        const now=new Date();
        const nepaliDate = now.toLocaleString('ne-NP', { hour12:false });
        submittedAtInput.value = nepaliDate;
        submitBtn.style.display='inline-block';
      }
    },1000);
  }

  questions.forEach(q=>q.addEventListener('change',()=>checkAnswerAndNext()));
  showQuestion(0);

  submitBtn.addEventListener('click',()=>quizForm.submit());
</script>
</body>
</html>
